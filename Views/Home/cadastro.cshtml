@{
    ViewData["Title"] = "Cadastro e Manutenção de Veículos";
}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro de Veiculos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        /* CSS para garantir altura total e evitar que o conteúdo fique atrás de um rodapé */
        html, body {
            height: 100%;
        }
    </style>
</head>
<body onload="listar_veiculos()">
    <div class="container-fluid mt-5">
        <h2 class="mb-4">Manutenção de Veículos 🚗</h2>
        <div class="alert alert-info" id="mensagem_id" role="alert" style="display:none;">
            Selecionado Veículo ID: <span id="id_selecionado"></span>
        </div>

        <h3 class="mt-4">Veículos Cadastrados</h3>
        <table class="table table-striped table-hover" id="tabelaLista">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Ano</th>
                    <th>Cor</th>
                    <th>Preço</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="corpo_tabela_lista">
            </tbody>
        </table>

        <h3 class="mt-5 mb-4">Novo Cadastro ou Edição</h3>
        <form id="formCadastro">
            <input type="hidden" id="idVeiculo" value="0" /> <div class="mb-3">
                <label for="marca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="marca" placeholder="Digite a Marca" required />
            </div>

            <div class="mb-3">
                <label for="modelo" class="form-label">Modelo</label>
                <input type="text" class="form-control" id="modelo" placeholder="Digite o modelo" required />
            </div>
            <div class="mb-3">
                <label for="ano" class="form-label">Ano</label>
                <input type="text" class="form-control" id="ano" placeholder="Digite o ano" required />
            </div>
            <div class="mb-3">
                <label for="cor" class="form-label">Cor</label>
                <input type="text" class="form-control" id="cor" placeholder="Digite a cor" required />
            </div>
            <div class="mb-3">
                <label for="preco" class="form-label">Preço</label>
                <input type="text" class="form-control" id="preco" placeholder="Digite o preço" required />
            </div>

            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-success" onclick="salvar_dados()">Salvar / Alterar</button>
                <button type="button" class="btn btn-danger" onclick="deletar_dados()">Deletar Selecionado</button>
                <button type="button" class="btn btn-secondary" onclick="limpar_form()">Novo Cadastro</button>
                <button type="button" class="btn btn-primary" onclick="window.location.href='/Home/Index'">Sair</button>
            </div>
        </form>
    </div>
    <script>
        // Função para limpar o formulário e preparar para um novo cadastro
        function limpar_form() {
            document.getElementById("idVeiculo").value = "0";
            document.getElementById("marca").value = "";
            document.getElementById("modelo").value = "";
            document.getElementById("ano").value = "";
            document.getElementById("cor").value = "";
            document.getElementById("preco").value = "";
            document.getElementById("mensagem_id").style.display = "none";
        }

        // Função para preencher o formulário ao clicar em um item da tabela
        function selecionar_veiculo(id, marca, modelo, ano, cor, preco) {
            document.getElementById("idVeiculo").value = id;
            document.getElementById("marca").value = marca;
            document.getElementById("modelo").value = modelo;
            document.getElementById("ano").value = ano;
            document.getElementById("cor").value = cor;
            document.getElementById("preco").value = preco;

            // Atualiza a mensagem de ID selecionado
            document.getElementById("id_selecionado").textContent = id;
            document.getElementById("mensagem_id").style.display = "block";
            window.scrollTo(0, 0); // Opcional: rola a página para o topo
        }

        // 1. Função para Listar Veículos (Usando a mesma lógica do estoque, mas sem filtro)
        async function listar_veiculos() {
            // Requisita todos os veículos (modelo vazio)
            var url = "/Home/BuscarVeiculo";
            var resp = await fetch(url);
            var meujson = await resp.json();

            var linhas_tabela = "";
            for (i = 0; i < meujson.length; i++) {
                var v = meujson[i];
                linhas_tabela += `
                    <tr>
                        <td>${v.id}</td>
                        <td>${v.marca}</td>
                        <td>${v.modelo}</td>
                        <td>${v.ano}</td>
                        <td>${v.cor}</td>
                        <td>${v.preco}</td>
                        <td>
                            <button type="button" class="btn btn-info btn-sm"
                                onclick="selecionar_veiculo('${v.id}', '${v.marca}', '${v.modelo}', '${v.ano}', '${v.cor}', '${v.preco}')">
                                Selecionar
                            </button>
                        </td>
                    </tr>`;
            }

            document.getElementById("corpo_tabela_lista").innerHTML = linhas_tabela;
        }

        // 2. Função para Coletar Dados (ajustada para incluir o ID)
        function coletar_dados_form() {
            var meu_json = {};
            meu_json.id     = parseInt(document.getElementById("idVeiculo").value); // Coleta o ID
            meu_json.marca  = document.getElementById("marca").value;
            meu_json.modelo = document.getElementById("modelo").value;
            meu_json.ano    = document.getElementById("ano").value;
            meu_json.cor    = document.getElementById("cor").value;
            meu_json.preco  = document.getElementById("preco").value;

            return meu_json;
        }

         // 3. Função Salvar/Alterar (Determina se é Insert ou Update)
        async function salvar_dados() {
            var meu_json = coletar_dados_form();
            var is_insert = meu_json.id === 0; // Se ID for 0, é INSERT. Se for > 0, é UPDATE.

            var url = is_insert ? "/Home/inserirVeiculo/" : "/Home/AlterarVeiculo/";

            try {
                var res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-type": "application/json" },
                    body: JSON.stringify(meu_json)
                });

                if (!res.ok) {
                    throw new Error(`Erro no servidor: ${res.status} ${res.statusText}`);
                }

                var json_resp = await res.json();
                alert(json_resp);

                limpar_form();        // Limpa o formulário
                listar_veiculos();    // Recarrega a lista para mostrar a alteração/inclusão

            } catch (erro) {
                alert(`Falha ao salvar os dados. Detalhes: ${erro.message}`);
            }
        }

        // 4. Função Deletar
        async function deletar_dados() {
            var id_para_deletar = parseInt(document.getElementById("idVeiculo").value);

            if (id_para_deletar === 0) {
                alert("Nenhum veículo selecionado para deletar. Por favor, selecione um na lista.");
                return;
            }

            if (!confirm(`Tem certeza que deseja DELETAR o veículo com ID: ${id_para_deletar}?`)) {
                return; // Se o usuário cancelar, não faz nada
            }

            var url = "/Home/DeletarVeiculo/";

            try {
                var res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-type": "application/json" },
                    body: JSON.stringify(id_para_deletar) // Envia apenas o ID como JSON puro
                });

                if (!res.ok) {
                    throw new Error(`Erro no servidor: ${res.status} ${res.statusText}`);
                }

                var json_resp = await res.json();
                alert(json_resp);

                limpar_form();        // Limpa o formulário
                listar_veiculos();    // Recarrega a lista

            } catch (erro) {
                alert(`Falha ao deletar os dados. Detalhes: ${erro.message}`);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
